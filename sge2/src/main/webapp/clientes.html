<!DOCTYPE html>
<html>
<head>
    <title>Clientes</title>

    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="main.css" />
</head>
<body>
        <div class="container">
                <div class="page-header" id = "header">
                    
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="panel with-nav-tabs panel-primary">
                            <div class="panel-heading">
                                    <ul class="nav nav-tabs">
                                        <li class="active"><a href="#tabPrimary" data-toggle="tab" onclick="cargarTab(1)">Mi Hogar</a></li>
                                        <li><a href="#tabPrimary" data-toggle="tab" onclick="cargarTab(2)">ABM Reglas y Dispositivos</a></li>
                                        <li><a href="#tabPrimary" data-toggle="tab" onclick="cargarTab(3)">Archivo de Dispositivos</a></li>
                                        <li class="dropdown">
                                            <a href="#" data-toggle="dropdown">Dropdown <span class="caret"></span></a>
                                            <ul class="dropdown-menu" role="menu">
                                                <li><a href="#tabPrimary" data-toggle="tab">Primary 4</a></li>
                                                <li><a href="#tabPrimary" data-toggle="tab">Primary 5</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                            </div>
                            <div class="panel-body">
                                <div class="tab-content" id="tabs"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="edit" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                <div class="modal-dialog">
              <div class="modal-content">
                    <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                  <h4 class="modal-title custom_align" id="Heading">Edit Your Detail</h4>
                </div>
                    <div class="modal-body">
                    <div class="form-group">
                  <input class="form-control " type="text" placeholder="Mohsin">
                  </div>
                  <div class="form-group">
                  
                  <input class="form-control " type="text" placeholder="Irshad">
                  </div>
                  <div class="form-group">
                  <textarea rows="2" class="form-control" placeholder="CB 106/107 Street # 11 Wah Cantt Islamabad Pakistan"></textarea>
              
                  
                  </div>
                </div>
                    <div class="modal-footer ">
                  <button type="button" class="btn btn-warning btn-lg" style="width: 100%;"><span class="glyphicon glyphicon-ok-sign"></span> Update</button>
                </div>
                  </div>
              <!-- /.modal-content --> 
            </div>
                <!-- /.modal-dialog --> 
              </div>
              
              
              
              <div class="modal fade" id="delete" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                <div class="modal-dialog">
              <div class="modal-content">
                    <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                  <h4 class="modal-title custom_align" id="Heading">Eliminar dispositivo</h4>
                </div>
                    <div class="modal-body">
                 
                 <div class="alert alert-danger"><span class="glyphicon glyphicon-warning-sign"></span> Está seguro que desea eliminar este dispositivo?</div>
                 
                </div>
                  <div class="modal-footer ">
                  <button type="button" onclick="eliminarDispositivo()" class="btn btn-success" ><span class="glyphicon glyphicon-ok-sign"></span> Si</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span> No</button>
                </div>
                  </div>
              <!-- /.modal-content --> 
            </div>
                <!-- /.modal-dialog --> 
              </div>
</body>

<script id="tab-template1" type="text/x-handlebars-template">
    <div class="tab-pane active" id="tabPrimary">Primary 1 {{usuario.nombre}}</div>
</script>

<script id="tab-template3" type="text/x-handlebars-template">
    <div class="tab-pane active" id="tabPrimary">
        <h4>Seleccionar archivo desde su computadora</h4>
          <form action="" method="post" enctype="multipart/form-data" id="js-upload-form">
            <div class="form-inline">
              <div class="form-group">
                <input type="file" accept=".json, .txt" name="files" id="archivo">
              </div>
              <button type="button" onclick="handleFileSelect()" class="btn btn-sm btn-primary" id="enviar-archivo">Enviar</button>
            </div>
          </form>
    </div>
</script>

<script id="tab-template2" type="text/x-handlebars-template">
    <div class="tab-pane active" id="tabPrimary">
        <div class="table-responsive">

                
              <table id="mytable" class="table table-bordred table-striped">
                   
                   <thead>
                   
                   <th>Id</th>
                    <th>Nombre</th>
                     <th>Consumo x Hora</th>
                     <th>Horas encendido</th>
                     <th>Es Inteligente</th>
                     <th>Es de Bajo Consumo</th>
                      <th>Editar</th>
                      
                       <th>Eliminar</th>
                   </thead>
                    <tbody></tbody>
        
            </table>

<div class="clearfix"></div>

                
        </div>
        <div>
            <h3>
                Nuevo dispositivo
            </h3>
            <form>
                <div class="form-group">
                <label for="sel1">Seleccionar dispositivo a agregar</label>
                <select class="form-control" id="sel1">
                </select>
                </div>
                <div>
                    <button type="button" onclick="agregarDispositivo()" class="pull-right btn btn-md btn-success" >Agregar</button>
                </div>
            </form>
        </div>
    </div>
</script>

<script id="header-template" type="text/x-handlebars-template">
    <h1>Bienvenido al control de su hogar<span class="pull-right label label-default">{{usuario.nombre}} <a onclick="desloguear()" style="cursor: pointer">
        <span class="glyphicon glyphicon-log-out"></span>
      </a></span></h1>
</script>

<script>
var dataSession = sessionStorage.getItem("data");
var datosUsuario = JSON.parse(dataSession);

function cargarTab(idTab) {
    $('#tabs').html('');

    var context={
        "usuario":{
            "nombre": datosUsuario.nombre
        }
    };

    if ($("#tab-template"+idTab).length != 0) {
        $(function () {
                // Grab the template script
                var theTemplateScript = $("#tab-template"+idTab).html();
              
                // Compile the template
                var theTemplate = Handlebars.compile(theTemplateScript);
    
                // Pass our data to the template
                var theCompiledHtml = theTemplate(context);
                  
                // Add the compiled html to the page
                $('#tabs').html(theCompiledHtml);

                if (idTab === 2) {
                    llenarTablaDispositivos();
                    cargarDispositivosPosibles();
                }
        });        
    }
        
}

function cargarHeader() {
    $('#header').html('');
    var context={
        "usuario":{
            "nombre": datosUsuario.nombre
        }
    };

    if ($("#header-template").length != 0) {
        $(function () {
                // Grab the template script
                var theTemplateScript = $("#header-template").html();
              
                // Compile the template
                var theTemplate = Handlebars.compile(theTemplateScript);
    
                // Pass our data to the template
                var theCompiledHtml = theTemplate(context);
                  
                // Add the compiled html to the page
                $('#header').html(theCompiledHtml);
        });        
    }

}

function desloguear() {
    sessionStorage.clear();
    window.location.href = "home.html";
}

function guardarDispAEliminar(id) {
    sessionStorage.setItem("dispAEliminar", id);
}

function eliminarDispositivo() {
    var id = sessionStorage.getItem("dispAEliminar");
    console.log(id);
}

function llenarTablaDispositivos() {
    var ruta = window.location.origin+`/sge2/api/dispositivos/obtener/dispPorCliente?id=${datosUsuario.id}`;
    var dispositivos;

    $.ajax({ type:"GET",
    async: false,
    url: ruta,
    contentType: "application/json",
    accept:"json",
    cache: false,
    error: function(jqXHR, textStatus, errorThrown){
      estado = false;
    },
    success: function(data){
        dispositivos = JSON.parse(data);
        estado = true;
    }
    });


    var table = $("#mytable tbody");
    dispositivos.forEach(disp => {
        table.append(`
        <tr>
    <td>${disp.id}</td>
    <td>${disp.nombre_generico}</td>
    <td>${disp.consumoKWHora}</td>
    <td>${disp.horasEncendido}</td>
    <td>${disp.Inteligente}</td>
    <td>${disp.BajoConsumo}</td>
    <td><p data-placement="top" data-toggle="tooltip" title="Editar"><button class="btn btn-primary btn-xs" data-title="Edit" data-toggle="modal" data-target="#edit" ><span class="glyphicon glyphicon-pencil"></span></button></p></td>
    <td><p data-placement="top" data-toggle="tooltip" title="Eliminar"><button onclick="guardarDispAEliminar(${disp.id})" class="btn btn-danger btn-xs" data-title="Delete" data-toggle="modal" data-target="#delete" ><span class="glyphicon glyphicon-trash"></span></button></p></td>
    </tr>
        `);
    });
}

function cargarDispositivosPosibles() {
    var ruta = window.location.origin+`/sge2/api/dispositivos/obtener/dispPosibles`;
    var dispositivosPosibles;

    $.ajax({ type:"GET",
    async: false,
    url: ruta,
    contentType: "application/json",
    accept:"json",
    cache: false,
    error: function(jqXHR, textStatus, errorThrown){
      estado = false;
    },
    success: function(data){
        dispositivosPosibles = JSON.parse(data);
        estado = true;
    }
    });

    var list = $("#sel1")
    dispositivosPosibles.forEach(dispPos => {
        list.append(`
        <option value="${dispPos.id}">${dispPos.nombre_generico}</option>`);
    });
}

function agregarDispositivo() {
    console.log($("#sel1").val());
    location.reload();
}

function handleFileSelect(){
    if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
      alert('The File APIs are not fully supported in this browser.');
      return;
    }   

    input = document.getElementById('archivo');
    if (!input) {
      alert("Um, couldn't find the fileinput element.");
    }
    else if (!input.files) {
      alert("This browser doesn't seem to support the `files` property of file inputs.");
    }
    else if (!input.files[0]) {
      alert("Por favor selecciona un archivo tocando el boton 'Seleccionar archivo'");               
    }
    else {
      file = input.files[0];
      fr = new FileReader();
      fr.onload = grabarArchivoDispositivos;
      fr.readAsText(file);
    }
  }

  function receivedText() {
    console.log(fr.result);
  }   



function grabarArchivoDispositivos() {

var ruta = window.location.origin+"/sge2/api/dispositivos/cargarArchivo";

var request = {
  archivo: fr.result,
  idUsuario: datosUsuario.id
}

$.ajax({ type:"POST",
async: false,
url: ruta,
data: JSON.stringify(request),
dataType:"json",
contentType: "application/json",
accept:"json",
cache: false,
error: function(jqXHR, textStatus, errorThrown){
    alert("Hubo un error al grabar los dispositivos")
  estado = false;
},
success: function(data){
    
    var dispNuevo = JSON.parse(JSON.stringify(data));

    alert(`Se han dado grabado los dispositivos con exito`)
  estado = true;
}
});
} 


$(document).ready(function() {
    cargarHeader();
    cargarTab(1);
});
</script>

</html>